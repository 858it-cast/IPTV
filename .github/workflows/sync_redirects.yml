name: Sync M3U8 Redirects

on:
  schedule:
    - cron: '0 * * * *'  # Run hourly
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-sync]

jobs:
  generate_redirects:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout IPTV repo
        uses: actions/checkout@v4

      - name: Fetch M3U8 files from private repo
        uses: actions/checkout@v4
        with:
          repository: tuouser/ytm3u8
          token: ${{ secrets.ACCESS_TOKEN }}
          path: ytm3u8-files
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create redirect endpoints
        run: |
          mkdir -p hls-redirects
          
          # Process each .m3u8 file
          for m3u8_file in ytm3u8-files/YouTubeLive/*.m3u8; do
            [ ! -f "$m3u8_file" ] && continue
            filename=$(basename "$m3u8_file")
            channel_name="${filename%.*}"
            hls_url=$(cat "$m3u8_file")
            
            # Generate JS redirect
            cat <<EOF > "hls-redirects/${filename}"
            <!DOCTYPE html
