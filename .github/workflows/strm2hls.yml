name: Deploy IPTV M3U8 with Proper Headers

on:
  push:
    paths:
      - 'ytm3u8/*.strm'
  workflow_dispatch:

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Generate Valid M3U8 Files
        run: |
          mkdir -p ./m3u8_output
          cd ytm3u8
          for strm_file in *.strm; do
            if [ -f "$strm_file" ]; then
              base_name=$(basename "$strm_file" .strm)
              hls_url=$(cat "$strm_file")
              
              # Genera file M3U8 con metadati completi
              echo -e "#EXTM3U\n#EXTINF:-1 tvg-id=\"${base_name}\" tvg-name=\"${base_name}\",${base_name}\n${hls_url}" > "../m3u8_output/${base_name}.m3u8"
            fi
          done

      - name: Validate Files
        run: |
          cd m3u8_output
          for m3u8_file in *.m3u8; do
            if ! grep -q "#EXTM3U" "$m3u8_file"; then
              echo "::error file=$m3u8_file::Invalid M3U8 format"
              exit 1
            fi
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ./m3u8_output
          name: iptv-m3u8

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
